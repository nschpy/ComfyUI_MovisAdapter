# ComfyUI MovisAdapter - Руководство по использованию

## Установка

```bash
cd ComfyUI/custom_nodes/ComfyUI_MovisAdapter
pip install -e .
```

После установки перезапустите ComfyUI.

## Доступные ноды

### 1. Load Video (video/moviepy/load)

**Описание:** Загружает видео из файла.

**Входные параметры:**
- `video_path` (STRING) - полный путь к видеофайлу
- `audio` (BOOLEAN) - загружать ли аудиодорожку (по умолчанию: True)

**Выход:** VIDEO

**Пример использования:**
```
video_path: /path/to/video.mp4
audio: True
```

---

### 2. Save Video (video/moviepy/save)

**Описание:** Сохраняет видео в файл.

**Входные параметры:**
- `video` (VIDEO) - видео для сохранения
- `filename` (STRING) - имя выходного файла (по умолчанию: "output.mp4")
- `codec` (COMBO) - видеокодек: libx264, libx265, mpeg4
- `bitrate` (STRING) - битрейт видео (по умолчанию: "8000k")
- `audio_codec` (COMBO) - аудиокодек: aac, mp3, libvorbis
- `preset` (COMBO) - пресет кодирования: ultrafast, fast, medium, slow

**Выход:** STRING (путь к сохраненному файлу)

---

### 3. Concatenate Videos (video/moviepy/edit)

**Описание:** Объединяет несколько видео в одно с переходами.

**Входные параметры:**
- `videos` (VIDEO, список) - список видеоклипов для склейки
- `mode` (COMBO) - режим: "simple" (без переходов) или "transition" (с переходами)
- `transition_type` (COMBO) - тип перехода:
  - `none` - без перехода
  - `crossfade` - плавное затухание/появление
  - `fade_black` - через черный экран
  - `fade_white` - через белый экран
  - `slide_left` - сдвиг влево
  - `slide_right` - сдвиг вправо
  - `zoom_in` - приближение
  - `zoom_out` - отдаление
- `transition_duration` (FLOAT) - длительность перехода в секундах (0.1-10.0)

**Выход:** VIDEO

**Примечание:** Автоматически нормализует FPS и разрешение всех клипов.

---

### 4. Video Effects (video/moviepy/edit)

**Описание:** Применяет визуальные эффекты к видео.

**Входные параметры:**
- `video` (VIDEO) - входное видео
- `effect_type` (COMBO) - тип эффекта:
  - `none` - без эффекта
  - `blur` - размытие
  - `sharpen` - повышение резкости
  - `mirror_x` - горизонтальное отражение
  - `mirror_y` - вертикальное отражение
  - `speed_up` - ускорение
  - `slow_down` - замедление
  - `noise` - добавление шума
  - `vignette` - виньетирование
- `intensity` (FLOAT) - интенсивность эффекта (0.0-10.0)
- `blur_radius` (INT, опционально) - радиус размытия для blur (1-20)
- `speed_factor` (FLOAT, опционально) - коэффициент скорости (0.1-10.0)
- `noise_level` (FLOAT, опционально) - уровень шума (0.0-1.0)

**Выход:** VIDEO

---

### 5. Color Grading (video/moviepy/edit)

**Описание:** Применяет цветокоррекцию к видео.

**Входные параметры:**
- `video` (VIDEO) - входное видео
- `brightness` (FLOAT) - яркость (-1.0 до 1.0, 0.0 = без изменений)
- `contrast` (FLOAT) - контраст (-1.0 до 1.0, 0.0 = без изменений)
- `saturation` (FLOAT) - насыщенность (-1.0 до 1.0, 0.0 = без изменений)
- `gamma` (FLOAT) - гамма-коррекция (0.1 до 3.0, 1.0 = без изменений)
- `hue_shift` (FLOAT) - сдвиг цветового тона (-180 до 180 градусов)

**Выход:** VIDEO

**Все параметры применяются за один проход для оптимальной производительности.**

---

### 6. Video to Images (video/moviepy/convert)

**Описание:** Конвертирует видео в последовательность кадров (IMAGE).

**Входные параметры:**
- `video` (VIDEO) - входное видео
- `fps` (FLOAT, опционально) - частота извлечения кадров (0 = использовать FPS видео)
- `start_time` (FLOAT, опционально) - время начала в секундах (по умолчанию: 0.0)
- `end_time` (FLOAT, опционально) - время окончания в секундах (0 = до конца видео)

**Выход:** IMAGE (torch.Tensor в формате [B, H, W, C])

**Примечание:** Полученные кадры можно обработать любыми нодами ComfyUI для работы с изображениями.

---

## Примеры workflow

### Пример 1: Простая обработка видео

```
LoadVideo → VideoEffects (blur) → ColorGrading (brightness +0.2) → SaveVideo
```

### Пример 2: Склейка видео с переходами

```
LoadVideo (video1.mp4) ─┐
                         ├─→ VideoConcatenate (mode: transition, type: crossfade) → SaveVideo
LoadVideo (video2.mp4) ─┘
```

### Пример 3: Извлечение и обработка кадров

```
LoadVideo → VideoToImages → [любые image-ноды ComfyUI] → [преобразование обратно в видео]
```

### Пример 4: Комплексная обработка

```
LoadVideo → VideoEffects (sharpen) → ColorGrading → VideoEffects (vignette) → SaveVideo
```

---

## Технические особенности

### Формат данных VIDEO

Кастомный тип данных `VIDEO` — это обертка над `VideoClip` из MoviePy, которая:
- Хранит информацию о FPS, разрешении, длительности
- Передается между нодами без необходимости сохранения на диск
- Оптимизирована для минимизации копирования данных

### Производительность

- **Ленивая загрузка**: MoviePy загружает видео по мере необходимости
- **Цветокоррекция**: Все параметры применяются за один проход
- **Нормализация**: При склейке видео автоматически приводятся к общему формату

### Обработка ошибок

Все ноды включают валидацию входных данных:
- Проверка существования файлов
- Проверка корректности параметров
- Автоматическое создание выходных директорий
- Информативные сообщения об ошибках

---

## Зависимости

- `moviepy` - основная библиотека для работы с видео
- `scipy` - для продвинутых фильтров изображений
- `numpy` - операции с массивами (поставляется с MoviePy)
- `torch` - тензорные операции (поставляется с ComfyUI)

---

## Устранение неполадок

### "No module named 'moviepy'"

Установите зависимости:
```bash
pip install -e .
```

### "Failed to load video"

Проверьте:
- Существует ли файл по указанному пути
- Поддерживается ли формат видео (mp4, avi, mov, mkv и др.)
- Установлен ли ffmpeg в системе

### Медленная обработка

- Используйте меньшее разрешение видео
- Уменьшите FPS при извлечении кадров
- Используйте более быстрые пресеты кодирования (ultrafast, fast)

---

## Лицензия

GNU General Public License v3

## Поддержка

Для сообщения об ошибках и предложений:
https://github.com/nschpy/ComfyUI_MovisAdapter/issues

